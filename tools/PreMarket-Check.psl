$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

# Derive repo root from this script's folder (tools -> repo root)
$repo = Split-Path $PSScriptRoot -Parent
Set-Location $repo

# Allow override via HAT_PYTHON; default to "python"
$py = $env:HAT_PYTHON
if (-not $py) {
    $py = "python"
}

# 1) Run the Python pre-market gate (RiskPulse + QoS)
& $py -m hybrid_ai_trading.tools.pre_market_check
$code = $LASTEXITCODE

if ($code -eq 0) {
    Write-Host "Pre-market check: OK_TO_TRADE (exit 0)" -ForegroundColor Green

    # 1b) Phase-5 multi-symbol orchestration (NVDA/SPY/QQQ) â€“ research/journal only
    try {
        $orchPath = Join-Path $repo 'tools\Run-Phase5MultiSymbol.ps1'
        if (Test-Path $orchPath) {
            Write-Host "[PreMarket-Check] Running Phase-5 multi-symbol orchestration (NVDA/SPY/QQQ)..." -ForegroundColor Cyan
            & $orchPath
        } else {
            Write-Host "[PreMarket-Check] WARNING: Orchestrator not found at $orchPath; skipping Phase-5 multi-symbol run." -ForegroundColor Yellow
        }
    } catch {
        Write-Host "[PreMarket-Check] WARNING: Phase-5 multi-symbol orchestration failed: $($_.Exception.Message)" -ForegroundColor Yellow
    }
}
elseif ($code -eq 2) {
    Write-Host "Pre-market check: HALT (no RiskPulse snapshot; warm up replay/risk first)" -ForegroundColor Red
}
elseif ($code -eq 3) {
    Write-Host "Pre-market check: HALT (risk limits breached)" -ForegroundColor Red
}
elseif ($code -eq 4) {
    Write-Host "Pre-market check: HALT (provider QoS degraded)" -ForegroundColor Red
}
else {
    Write-Host ("Pre-market check: HALT (unexpected exit code {0})" -f $code) -ForegroundColor Red
}

# NOTE: We no longer exit the host here; just record the code for callers.
$global:LASTEXITCODE = $code
Write-Host ("[PreMarket-Check] Completed with code {0}" -f $code) -ForegroundColor DarkGray