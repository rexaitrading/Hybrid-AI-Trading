name: Phase3 CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - src/main
      - feature/phase1-bar-replay

permissions:
  contents: read

env:
  SKIP: pre-commit
  GIT_TERMINAL_PROMPT: 0

jobs:
  micro-tests:
    name: Micro tests (isolated, fast)
    runs-on: windows-latest
    timeout-minutes: 10
    env:
      HAT_REPORT_DIR: ${{ github.workspace }}
      PYTHONPATH: ${{ github.workspace }}\src
      PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: "3.12" }

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Ensure CI dirs
        if: runner.os == 'Windows'
        shell: pwsh
        run: New-Item -ItemType Directory -Force .ci | Out-Null

      - name: Print sys.path & imported logger (PowerShell-safe)
        shell: pwsh
        run: >
          python -c "import sys,importlib,inspect;
          print('sys.path[:6]=',sys.path[:6]);
          m=importlib.import_module('hybrid_ai_trading.runners.paper_logger');
          print('IMPORTED_FROM:',m.__file__);
          src=inspect.getsource(m);
          print('HAS_NORMALIZE:', '_normalize_log_path(' in src)"

      - name: Install test deps (no package install)
        shell: pwsh
        run: |
          python -m pip install -U pip wheel
          pip install pytest pytest-cov

      - name: Run micro tests
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File .\scripts\run_full_repo_tests.ps1 -Mode Isolated

      - name: Upload .ci artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-micro
          path: .ci
          if-no-files-found: ignore

  full-repo-cov:
    name: Full repo tests with coverage
    runs-on: windows-latest
    needs: micro-tests
    timeout-minutes: 20
    env:
      HAT_REPORT_DIR: ${{ github.workspace }}
      PYTHONPATH: ${{ github.workspace }}\src
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: "3.12" }

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Ensure CI dirs
        if: runner.os == 'Windows'
        shell: pwsh
        run: New-Item -ItemType Directory -Force .ci | Out-Null

      - name: Print sys.path & imported logger (PowerShell-safe)
        shell: pwsh
        run: >
          python -c "import sys,importlib,inspect;
          print('sys.path[:6]=',sys.path[:6]);
          m=importlib.import_module('hybrid_ai_trading.runners.paper_logger');
          print('IMPORTED_FROM:',m.__file__);
          src=inspect.getsource(m);
          print('HAS_NORMALIZE:', '_normalize_log_path(' in src)"

      - name: Install test deps (no package install)
        shell: pwsh
        run: |
          python -m pip install -U pip wheel
          pip install pytest pytest-cov

      - name: Run tests + coverage
        shell: pwsh
        run: python -m pytest -q --cov=src --cov-report=term-missing --cov-report=xml

      - name: Enforce coverage >= 70%
        shell: pwsh
        run: |
          [xml]$xml = Get-Content .\coverage.xml
          $rate = [double]$xml.coverage.'line-rate'
          Write-Host "line-rate: $rate"
          if ($rate -lt 0.70) { Write-Error "Coverage under 70% ($rate)"; exit 1 }

      - name: Upload coverage + .ci artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-and-ci-logs
          path: |
            coverage.xml
            .ci
          if-no-files-found: ignore


