name: tests (py3.12)

on:
  push:
    branches:
      - feat/ci-restore-pytest-*
    paths-ignore:
      - 'ci_artifacts/**'
  pull_request:
  workflow_dispatch:# Cancel older runs for the same ref if a new one starts
concurrency:
  group: tests-py312-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  py312:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package and deps
        run: |
          python -V
          python -m pip install --upgrade pip wheel setuptools
          pip install --only-binary=:all: llvmlite==0.43.*
          pip install -e .
      # Filter out self-repo line to avoid nested clone
      sed -E '/hybrid_ai_trading\s*@\s*git\+|Hybrid-AI-Trading\.git/d' requirements.txt > requirements.ci.txt
      pip install -r requirements.ci.txt || true
          pip install -r requirements.txt || true
          python - << 'PY'
          import importlib,sys
          print("PYTHON:", sys.version)
          for m in ("llvmlite","sqlalchemy","greenlet","ibapi","ccxt","requests","dotenv"):
              try:
                  importlib.import_module(m if m!="dotenv" else "dotenv")
                  print("OK:", m)
              except Exception as e:
                  print("MISS:", m, e)
          PY

      - name: Run tests
        run: pytest -q
