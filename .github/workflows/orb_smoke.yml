name: ORB Smoke

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    - cron: "20 2 * * *"   # daily @ 02:20 UTC

permissions:
  contents: read

concurrency:
  group: orb-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  orb:
    runs-on: windows-latest
    timeout-minutes: 10

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: requirements-smoke.txt

      - name: Show Python & pip
        run: |
          python -V
          python -m pip -V

      - name: Bootstrap pip/setuptools/wheel
        run: python -m pip install -U pip setuptools wheel

      - name: Install smoke requirements (with retry)
        run: |
          $ErrorActionPreference = 'Stop'
          for ($i=1; $i -le 3; $i++) {
            try {
              python -m pip install --upgrade -r requirements-smoke.txt
              break
            } catch {
              if ($i -eq 3) { throw }
              Start-Sleep -Seconds (5 * $i)
            }
          }
      - name: Verify ORB hook present
        run: |
          @'
import io, sys
p = r"src/hybrid_ai_trading/tools/bar_replay.py"
try:
    t = io.open(p, encoding="utf-8").read()
except FileNotFoundError:
    raise SystemExit(f"Missing file: {p}")
assert 'setup="ORB"' in t, "ORB hook missing"
print("OK: ORB present")
'@ | python -
